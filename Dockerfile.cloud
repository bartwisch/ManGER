# Cloud Dockerfile - pulls code from GitHub at startup
# Only rebuild when DEPENDENCIES change, not code!
FROM pytorch/pytorch:2.5.1-cuda12.4-cudnn9-runtime

WORKDIR /app

# Install system dependencies, fonts, and git
RUN apt-get update && apt-get install -y \
    libgl1 \
    libglib2.0-0 \
    fonts-dejavu-core \
    fonts-liberation \
    fontconfig \
    git \
    && rm -rf /var/lib/apt/lists/* \
    && fc-cache -f -v

# Install Python dependencies (these rarely change)
RUN pip install --no-cache-dir \
    pydantic>=2.0.0 \
    pydantic-settings>=2.0.0 \
    pillow>=10.0.0 \
    opencv-python>=4.8.0 \
    numpy>=1.24.0 \
    streamlit>=1.28.0 \
    loguru>=0.7.0 \
    openai>=1.0.0 \
    httpx>=0.25.0 \
    pymupdf>=1.23.0 \
    beautifulsoup4>=4.12.0 \
    requests>=2.31.0 \
    transformers>=4.35.0 \
    einops>=0.7.0 \
    shapely>=2.0.0 \
    matplotlib>=3.7.0 \
    timm>=0.9.0 \
    playwright>=1.40.0

# Install Playwright browsers
RUN playwright install chromium && playwright install-deps chromium

# Copy startup script
COPY start_cloud.sh /start_cloud.sh
RUN chmod +x /start_cloud.sh

EXPOSE 8501

# Startup script pulls latest code then runs
CMD ["/start_cloud.sh"]
